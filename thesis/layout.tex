\startenvironment layout
\product thesis

\usepath[{./,frontmatter,backmatter}]

\usemodule[units]
\usemodule[bibtex]

\definemode[thesis][keep]
\definemode[draft][keep]

\definepapersize[ThesisSize][width=17cm, height=24cm]
\definepapersize[ThesisSizeLandscape][ThesisSize,landscape][ThesisSize,landscape]

\startmode[thesis]
\setuppapersize[ThesisSize]
\setuplayout[location=middle, width=13.0cm, height=19.6cm, 
             topspace=1.7cm, bottomspace=1.7cm, margin=2.0cm, 
             header=0.5cm, footer=0.5cm]
\stopmode

\startmode[draft]
\setuppapersize[A4]
\setupinterlinespace[big]
\stopmode
\setupindenting[yes, big, first]

\setuppagenumbering[alternative=doublesided, location=right]
%\setupheader[style=small]
%\setupheadertexts[][{\getmarking[chapter]}][{Chapter \getmarking[chapternumber]}][]

\definecolor[chap_frame][g=1,t=1,a=12]
\definecolor[textcolor] [r=1,t=1,a=12]
\startuseMPgraphic{rightthumbindex}
  path chap_frame ;
  pair pos, a, b ;  
  picture labeltext ;

  if  \somenamedheadnumber{Chapter}{current} > 0 :
     curr_chap := \somenamedheadnumber{Chapter}{current} ; 
  else :
     curr_chap := 1 ;
  fi;
  if \somenamedheadnumber{Chapter}{last} > 0 :
     last_chap := \somenamedheadnumber{Chapter}{last} ;
  else :
     last_chap := 1 ;
  fi;

  marginwidth := RightMarginWidth ;
  skip   := TextHeight * (curr_chap - 1) / 8 ;
  height := TextHeight / 8 ;
  width  := marginwidth / 2 ;
 
  labeltext := textext("\ssbfb\textcolor \getmarking[chapternumber]");

  StartPage ;
      chap_frame := fullsquare xyscaled(marginwidth, height) ;

      pos := urcorner Field[Text][RightMarginSeparator] -
             ulcorner chap_frame - (0, skip);

      fill chap_frame shifted pos withcolor \MPcolor{chap_frame};
      draw labeltext shifted pos withcolor \MPcolor{textcolor};
  StopPage ;
\stopuseMPgraphic

\defineoverlay[rightthumbindex][\useMPgraphic{rightthumbindex}]

\setupbackgrounds[rightpage][background=rightthumbindex]
%\setupbackgrounds[leftpage][background=leftthumbindex]

% heads
% numbered
\definehead[Chapter][chapter]
\definehead[Section][section]
\definehead[SubSection][subsection]
\definehead[Subsection][subsection]
\definehead[Subsubsection][subsubsection]
% unnumbered
\definehead[Subject][subject]
\definehead[Subsubject][subsubject]

\setupheads[indentnext=yes, style=bold]
\setupheads[align={flushleft,nothyphenated}, tolerance=verytolerant]

% abbreviations
\definesynonyms[abbreviation][abbreviations][\infull]

% figures
\setupexternalfigures[factor=broad, directory={chapter6/figures}]

% extra floats
% landscape
\definefloat[lfigure][lfigures][figure]
\definefloat[ltable][ltable][table]
% supplemental
\definefloat[stable][stables]
\definefloat[sfigure][sfigures]
% supplemental landscape
\definefloat[sltable][sltables][stable]
\definefloat[slfigure][slfigures][sfigure]

% tables
\setupTABLE[width=broad, style=small, align={middle,lohi}]
%\setupTABLEhead[width=broad, style=smallbold, align={middle,lohi}]

% labeltexts
\setuplabeltext[sfigure={Figure S}]
\setuplabeltext[stable={Table S}]
\setuplabeltext[slfigure={Figure S}]
\setuplabeltext[sltable={Table S}]

% captions
\setupcaptions[style=small, minwidth=0.9\textwidth]
\setupcaption[table][location=top]
\setupcaption[stable][location=top]
% landscape captions
\setupcaption[lfigure][width=0.9\textheight]
\setupcaption[ltable][width=0.9\textheight]
\setupcaption[slfigure][width=0.9\textheight]
\setupcaption[sltable][width=0.9\textheight]
\define[2]\caption{{\bf #1} #2}

\setupfootnotes[width=0.9\textwidth, rule=off,distance=0pt]

% references
\definereferenceformat[infigure][left=Figure ]
\definereferenceformat[intable][left=Table ]
\definereferenceformat[inchapter][left=Chapter ]
\definereferenceformat[ineq][left=Eq. ]
\definereferenceformat[insfigure][left=Figure S]
\definereferenceformat[instable][left=Table S]
\definereferenceformat[ins][left=S]

% shortcuts
\define \disvis {\emph{disvis}}
\define\powerfit{{\emph powerfit}}

% bibtex
\define[1] \citeauthor {\cite[authornum][#1]}
%\setupbibtex[database={chapter1/references,chapter2/references,chapter3/references,chapter4/references,chapter5/references,chapter6/references,haddock2.2-webserver/references,chapter7/references}, sort=author]

\setupbibtex[database={backmatter/all-references.bib}, sort=author]

\setuppublications[alternative=apa, refcommand=num, sorttype=cite, criterium=cite, numbering=yes]
%\setuppublicationlist[style=small]

\setuppublicationlayout[article]{%
    \insertartauthors{}{ }{\inserthekey{}{ }}%
    \insertpubyear{(}{). }{\unskip. }%
    \insertarttitle{\bgroup }{ \egroup}{}%
    \insertjournal{\bgroup \it}{\egroup}{\insertcrossref{In }{}{}}%
    \insertvolume{ \bgroup \bf}{\egroup}{}%
    \insertpages{, }{.}{.}%
    }
\setuppublicationlayout[book]{%
    \insertauthors{}{ }{\insertthekey{}{ }}%
    \insertpubyear{(}{). }{\unskip. }%
    \inserttitle{\bgroup }{ \egroup}{}%
    \insertpubname{}{}{.}%
    }
\setuppublicationlayout[electronic]{%
    \insertauthors{}{ }{\insertthekey{}{ }}%
    \insertpubyear{(}{). }{\unskip. }%
    \inserttitle{\bgroup }{ \egroup}{}
    \insertbiburl{}{.}{}%%
    }
\stopenvironment
