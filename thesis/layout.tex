\startenvironment layout
\product thesis

\usepath[{./,frontmatter,backmatter}]

\usemodule[units]
\usemodule[bibtex]

\definemode[thesis][keep]
\definemode[draft][keep]

\definepapersize[ThesisSize][width=17cm, height=24cm]

\setupinteraction[state=start]
%\startmode[thesis]
\setuppapersize[ThesisSize]
\setuplayout[location=middle, width=13.0cm, height=22cm, 
             topspace=1.0cm, bottomspace=1.0cm, margin=2.0cm, 
             header=1.0cm, footer=1.0cm]
%\stopmode

%\startmode[draft]
%\setuppapersize[A4]
%\setupinterlinespace[big]
%\stopmode
\setupindenting[yes, big, first]

\setuppagenumbering[alternative=doublesided, location=right]

% fontstyles
\definealternativestyle[table:head][\white\bf\tfx\ss]
\definealternativestyle[table:body][\tfx\ss]
\definealternativestyle[style:section][\tfa\bf\ss]
\definealternativestyle[style:subsection][\tf\bf\ss]
\definealternativestyle[style:subsubsection][\tf\it\ss]
\definealternativestyle[style:caption][\ss\tfx]

% thumb index code
\definecolor[tableheadcolor][darkgray]
\definecolor[tableoddrow][gray]
\startuseMPgraphic{thumbindex}
    path chap_frame ;
    pair pos;  
    picture labeltext ;
  
    nchapters := 8;
    curr_chap := \somenamedheadnumber{Chapter}{current} ; 
  
    % only do it for proper chapters
    if (curr_chap > 0):
           marginwidth := RightMarginWidth ;
           skip   := TextHeight * (curr_chap - 1) / nchapters ;
           height := TextHeight / nchapters ;
           width  := marginwidth * 0.75;
           offset := marginwidth - width;
           labeltext := textext("\ssbfd \white \getmarking[chapternumber]");
           chap_frame := fullsquare xyscaled(width, height) ;

           if (PageNumber mod 2) = 1:
               pos := ulcorner Field[Text][RightMarginSeparator] -
                      ulcorner chap_frame - (-offset, skip);
               % take care of bleeding
               chap_frame := chap_frame rightenlarged 3mm;
           else:
               pos := urcorner Field[Text][LeftMarginSeparator] -
                      urcorner chap_frame - (offset, skip);
               % take care of bleeding
               chap_frame := chap_frame leftenlarged 3mm;
           fi;

            StartPage;
                fill chap_frame shifted pos withcolor \MPcolor{gray};
                draw labeltext shifted pos withcolor \MPcolor{white};
            StopPage;
    fi;
\stopuseMPgraphic

% place thumb index
\defineoverlay[thumbindex][\useMPgraphic{thumbindex}]
\setupbackgrounds[page][background=thumbindex]

% heads
% numbered
\definehead[Chapter][chapter]
\definehead[Section][section]
\definehead[Subsection][subsection]
\definehead[Subsubsection][subsubsection]
% unnumbered

\setupheads[indentnext=yes]
\setupheads[align={flushleft,nothyphenated,verytolerant}, 
    tolerance=verytolerant]

% chapter page
\define[2]\MyChapter
    {\framed[frame=off, width=broad, align=flushleft]{#1 \blank[2em] #2}}
\setuplabeltext[chapter=Chapter~]
\setuphead[Chapter][command=\MyChapter, style=\tfb\bf\ss, indentnext=no]

% other heads
\setuphead[Section][style=style:section]
\setuphead[Subsection][style=style:subsection]
\setuphead[Subsubsection][number=no, style=style:subsubsection]

% unnumber sections
\definehead[Subject][Section]
\definehead[Subsubject][Subsection]
\setuphead[Subject][number=no]
\setuphead[Subsubject][number=no]

% abbreviations
\definesynonyms[abbreviation][abbreviations][\infull]

% figures
\setupexternalfigures[factor=broad, directory={chapter6/figures}]

% extra floats
% landscape
\definefloat[lfigure][lfigures][figure]
\definefloat[ltable][ltables][table]
% supplemental
\definefloat[stable][stables]
\definefloat[sfigure][sfigures]
% supplemental landscape
\definefloat[sltable][sltables][stable]
\definefloat[slfigure][slfigures][sfigure]

% tables
\setupTABLE[width=broad, style=table:body]
\setupTABLE[r][align=middle]
\setupTABLE[r][odd][background=color, backgroundcolor=tableoddrow]
\setupTABLE[r][1][background=color, backgroundcolor=tableheadcolor, style=table:head]

% labeltexts
\setuplabeltext[sfigure={Figure S}]
\setuplabeltext[stable={Table S}]
\setuplabeltext[slfigure={Figure S}]
\setuplabeltext[sltable={Table S}]

% captions
\setupcaptions[style=style:caption, minwidth=0.9\textwidth]
\setupcaption[table][location=top]
\setupcaption[stable][location=top]
% landscape captions
\setupcaption[lfigure][width=0.9\textheight]
\setupcaption[ltable][width=0.9\textheight]
\setupcaption[slfigure][width=0.9\textheight]
\setupcaption[sltable][width=0.9\textheight]
\define[2]\caption{{\bf #1} #2}

\setupfootnotes[width=0.9\textwidth, rule=off,distance=0pt]

% references
\definereferenceformat[infigure][left=Figure ]
\definereferenceformat[intable][left=Table ]
\definereferenceformat[inchapter][left=Chapter ]
\definereferenceformat[ineq][left=Eq. ]
\definereferenceformat[insfigure][left=Figure S]
\definereferenceformat[instable][left=Table S]
\definereferenceformat[ins][left=S]

% urls
\useURL[url:powerfit][https://github.com/haddocking/powerfit]
\useURL[url:disvis][https://github.com/haddocking/disvis]
\useURL[url:wenmr][http://www.wenmr.eu]
\useURL[url:egi][http://gstat.egi.eu/gstat/geo/openlayers\#/VO/enmr.eu]
\useURL[url:haddock2.2][http://haddock.science.uu.nl/services/HADDOCK2.2]
\useURL[url:proteinmodelportal][http://proteinmodelportal.org]
\useURL[url:gpyfft][https://github.com/geggo/gpyfft]
\useURL[url:clfft][https://github.com/clMathLibraries/clFFT]

% shortcuts
\define \disvis {\emph{disvis}}
\define\powerfit{{\emph powerfit}}


% bibtex

\setuppublications[alternative=apa, refcommand=num, sorttype=cite, 
        criterium=cite, numbering=yes]
\setuppublicationlist[style=\tfx\ss]
\setupcite[lastpubsep={,~}]
\define[1] \citeauthor {\cite[authornum][#1]}
\setupbibtex[database={backmatter/all-references.bib}, sort=author]

\setuppublicationlayout[article]{%
    \insertartauthors{}{ }{\inserthekey{}{ }}%
    \insertpubyear{(}{). }{\unskip. }%
    \insertarttitle{\bgroup }{ \egroup}{}%
    \insertjournal{\bgroup \it}{\egroup}{\insertcrossref{In }{}{}}%
    \insertvolume{ \bgroup \bf}{\egroup}{}%
    \insertpages{, }{.}{.}%
    }
\setuppublicationlayout[book]{%
    \insertauthors{}{ }{\insertthekey{}{ }}%
    \insertpubyear{(}{). }{\unskip. }%
    \inserttitle{\bgroup }{ \egroup}{}%
    \insertpubname{}{}{.}%
    }
\setuppublicationlayout[electronic]{%
    \insertauthors{}{ }{\insertthekey{}{ }}%
    \insertpubyear{(}{). }{\unskip. }%
    \inserttitle{\bgroup }{ \egroup}{}
    \insertbiburl{}{.}{}%%
    }
\stopenvironment
