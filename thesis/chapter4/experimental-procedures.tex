\define\EvdW{E_{\text{vdW}}}
\define\Eelec{E_{\text{elec}}}
\define\EAIR{E_{\text{AIR}}}
\define\Edesolv{E_{\text{desolv}}}
\define\Eitr{E_{\text{it0}}}
\define\Eitf{E_{\text{it1}}}
\define\Eitw{E_{\text{itw}}}


\Section{Experimental procedures}

\Subsection{HADDOCK protocol}

HADDOCK has been described in details in previous work \cite[Dominguez2003,
deVries2010a].  Its docking protocol consists of three stages: an initial rigid
body docking stage (it0), a semi-flexible refinement stage using simulated
annealing in torsion-angle space (it1) and a final flexible refinement stage in
explicit water (itw).  In it0, the subunits are treated as rigid entities.
They are separated in space by an approximate minimum distance of 25Å, each
subunit being given a random orientation and random translation within a 10Å
box.  In the ab initio mode of HADDOCK (HADDOCK-CM), center of mass restraints
are defined between the subunits to drive the docking, as described in
\citeauthor{Karaca2013}.  The initial complexes are generated by rigid
body energy minimization where the energy is a linear combination of the
intermolecular van der Waals and electrostatic energies and the empirical
distance (and other, e.g. symmetry) restraint term.  Typically 10000 models are
written to disk at this stage. The top 400 best scoring models are refined in
it1, using multiple cycles of simulated annealing in torsion angle space.  In
the final itw stage, the 400 structures are refined further using molecular
dynamics in Cartesian space with the complex solvated in an 8Å shell of
explicit TIP3P water.  Finally, the 400 structures are scored with the
itw-HADDOCK score.

After each stage the models are scored with the following pseudo-energy functions:

\placeformula[eq:haddock-it0]
\startformula
\Eitr = 0.1 \cdot \EvdW + 1.0 \cdot \Eelec + 0.01 \cdot \EAIR + 1.0 \cdot \Edesolv - 0.01 \cdot \text{BSA}
\stopformula

\placeformula[eq:haddock-it1]
\startformula
\Eitf = 1.0 \cdot \EvdW + 0.2 \cdot \Eelec + 0.1 \cdot \EAIR + 1.0 \cdot \Edesolv - 0.01 \cdot \text{BSA}
\stopformula

\placeformula[eq:haddock-itw]
\startformula
\Eitw = 1.0 \cdot \EvdW + 0.2 \cdot \Eelec + 0.1 \cdot \EAIR + 1.0 \cdot \Edesolv
\stopformula

where \m{\Eitr}, \m{\Eitf} and \m{\Eitw} are the scoring functions after the
it0, it1 and itw stage, respectively, \m{\EvdW} the intermolecular van der
Waals energy, \m{\Eelec} the intermolecular electrostatic energy,  \m{\EAIR}
the ambiguous interaction restraints energy, \m{\Edesolv} an empirical
desolvation energy \cite[Fernandez-Recio2004] and BSA is the buried surface
area in Å\high{2}.  The energies are calculated with an 8.5Å
cutoff based on OPLS parameters \cite[Jorgensen1988].

\Subsection{HADDOCK-EM protocol}

As HADDOCK uses CNS (Crystallography and NMR System) \cite[Brunger2007] as
computational engine, all crystallographic tools and energy function available
in CNS are available to HADDOCK.  So the cryo-EM data, represented by a 3D real
scalar field, can be directly read into the CNS framework and specific energy
functions, typically in reciprocal space, be used and applied.  The HADDOCK-EM
protocol uses in particular the xref energy term in CNS.  It is very similar to
the original HADDOCK method with some adjustments mainly in it0.  A graphical
representation of the adjusted it0-protocol is given in Figure 1.  An integral
part of our protocol is the use of centroids, where each centroid represents
the approximate position of the COM of a subunit in the density map.  When the
resolution of the cryo-EM data decreases, the orientation of the subunits can
be ambiguous but the approximate placement can still be determined.  This is
obvious in cases where several density maps are obtained with some subunits
being alternately present and absent in the set, such as in the case of the
ribosome \cite[Xu2008].  The position of the centroids can be determined in
multiple ways.  An objective way is to perform a full-exhaustive cross
correlation search to deduce regions of high cross correlation values; the
centroid can then be placed on the position with the highest value.  They can
be placed manually using graphics software: for example UCSF Chimera has an
option to place centroids in high-density regions in the map.  Another option
is to place an atomic structure in the density at an approximately correct
position, calculate its COM and use this as the position of the centroid.
Methods for automatic simultaneous detection of centroids have also been
reported \cite[Birmanns2007, Lasker2010, Wriggers1998, Zhang2010].  A more
elaborate approach uses experimental data in conjunction with the cryo-EM map
to infer the positions of the subunits, as was shown on the RNA polymerase II
\cite[Murakami2013].  The centroids are entered into HADDOCK-EM as Cartesian
coordinates in the start parameters.  Together with the cryo-EM map and its
resolution, they represent all the input required to run HADDOCK-EM. 

During the docking, each subunit is given a random orientation and initially
placed on a sphere centered on the midpoint of the centroids.  In the case of
two chains, the subunits are placed opposite each other on the sphere with a
minimal distance of 25Å between them.  Afterwards, for each docking trial, they
are given a random rotation and translation within a 10Å box to enhance the
sampling.  Distance restraints are defined between the COM of each subunit and
either all determined centroids as ambiguous restraints in cases where the
placement of the subunit in the density is ambiguous, or a specific centroid if
the placement is unambiguous.  The distance restraint is described by a soft
square potential between two pseudo atoms, one of which corresponding to the
centroid and the other to the COM of the subunit.  An initial complex is formed
by rigid body energy minimization, where the energy is a combination of the
force field, the centroid-based distance restraints and other possible
experimentally based distance and orientation restraints. 

After the initial energy minimization, for binary systems we properly orient
the complex in the density by performing a fine full-exhaustive search around
the axis that is formed by the line joining the centroids in 4° increments.
Each orientation is scored by the vector residual energy term in CNS, given by 

\placeformula[eq:vector-residual]
\startformula
E_{\mathrm{vector}} = \frac{\sum_H \left( F_{em} - F_c \right) ^2}{\sum_H F_{em}^2}
\stopformula

where the summation is over all the Miller indices \m{H} up to the specified
resolution of the cryo-EM map, and \m{F_{em}} and \m{F_c} are the complex-valued
Fourier coefficients of the cryo-EM map and the calculated density,
respectively.  It should be noted that minimizing the vector residual in
reciprocal space is mathematically the same as maximizing the cross correlation
in real space \cite[Navaza2002] and thus we refer to this potential simply as
the cross correlation.  The complex is reoriented in the density conforming to
the optimal cross correlation value found during the search.  A final rigid
body energy minimization is performed directly against the map using the cross
correlation (vector potential energy term in CNS), van der Waals and
electrostatic energy terms.  For each complex typically 10000 models are
generated this way. 

The models are then scored by adding a local cross correlation (LCC) term to
the regular HADDOCK score (\ineq[eq:haddock-it0] -- \inb[eq:haddock-itw]), where
the LCC is given by 

\placeformula[eq:lcc-definition]
\startformula
\mathrm{LCC} = \frac{\sum_i \left( \rho_{em} - \bar{\rho}_{em} \right) \cdot
\left( \rho_c - \bar{\rho}_c \right)}{\sigma_{em} \sigma_c}
\stopformula

where the summation is over the voxels \m{i} which are maximally 3Å away from an
atom of the model; \m{\rho_{em}} is the density value at voxel \m{i} of the cryo-EM
map; \m{\bar{\rho}_{em}} is the average density value of all the voxels \m{i};
\m{\rho_c} is the density value at voxel \m{i} of the calculated density,
\m{\bar{\rho}_c} is the average density value of all the voxels \m{i} of the
calculated density, and \m{\sigma_{em}} and \m{\sigma_c} are the standard
deviations of the cryo-EM and calculated density over the voxels \m{i},
respectively. The HADDOCK-EM scores are thus given by

\placeformula[eq:haddock-em-it0]
\startformula
E_{\text{it0,EM}} = \Eitr - w_{\text{it0}} \cdot \text{LCC}
\stopformula

\placeformula[eq:haddock-em-itw]
\startformula
E_{\text{itw,EM}} = \Eitf - w_{\text{itw}} \cdot \text{LCC}
\stopformula

where \m{w_{\text{it0}}} and \m{w_{\text{itw}}} are weight terms for the LCC
pseudo energy that need to be determined (see below). The top 400 best scoring
structures are selected for further flexible refinement in it1 and itw.  The
refinement protocols are similar to the standard HADDOCK protocol, however the
energy now also contains the additional cross correlation based energy term in
addition to the other force field and restraint energy terms. 

It should be noted that the maximum number of subunits that can be docked
simultaneously currently is restricted to 6 (this limitation will be lifted in
a future version).  Furthermore, in order to use the HADDOCK-EM protocol,
approximate knowledge of the position of each subunit in the form of centroids
is a requisite for a successful docking run.  Other minor requirements are that
the number of voxels in each dimension of the cryo-EM data is a multiple of 2,
3 and 5 to calculate FFTs used in the cross-correlation potential, and that the
density should be converted to CNS/XPLOR format.  For the latter two tasks,
Python scripts are included in the HADDOCK distribution.  Finally, the time
required for a HADDOCK-EM run decreases with decreasing map size, since this
speeds up the calculations of the FFTs.


\Subsection{Generation of simulated cryo-EM maps}

For the generation of the simulated cryo-EM maps we wrote a Python script based
on the molmap function in UCSF Chimera. The resulting density is described by:

\placeformula[eq:density]
\startformula
\rho\left(\vec{r}\right) = \sum_{i}^{N} A_i \cdot \exp\left( - \frac{\left| \vec{r} - \vec{r}_i \right|^2}{2\sigma^2} \right)
\stopformula

where \m{\rho} is the density value at position \m{\vec{r}}; the summation is over
all the atoms \m{N}; \m{A_i} is the atom number of atom \m{i}; \m{\vec{r}_i}  is the
position of atom \m{i}; and \m{\sigma}  is the standard deviation given by
\m{\frac{1}{\pi\sqrt{2}} \cdot R} , where \m{R} is the resolution.  This definition
of the standard deviation ensures that the magnitudes of the Fourier
coefficients are at \m{1/e} of its maximum value at the specified resolution.  The
extent of the Gaussian kernel was four times the standard deviation and the
voxel spacing one-fourth of the resolution. An example of a resulting 10, 15
and 20Å map is given in \insfigure[fig:simulated-densities].


\Subsection{Optimizing and benchmarking HADDOCK-EM}

The HADDOCK-EM protocol relies on the optimization of two parameters for the
docking, namely the force constant for the centroid based distance restraints
and the weight for the cross correlation energy term.  In addition, the weight
factors of the LCC term in the it0 and itw-HADDOCK score need to be determined.
For this, we used a benchmark consisting of 17 complexes taken from the
protein-protein docking benchmark 4.0 \cite[Hwang2010] (see \intable[tab:benchmark]).
Centroids were determined by calculating the COM of each unbound chain that is
optimally superimposed onto the native complex.

We first determined the centroid based force constant by running the benchmark
at different values for the force constant, creating 10000 models for each
complex in it0.  Since the force constant is only used in it0, the structures
were not scored nor refined.  The value for the force constant that gave the
most acceptable solutions, where an acceptable solution is defined as having an
i-RMSD <= 4.0Å compared to the native complex, was chosen (results not
shown).  The i-RMSDs were calculated using ProFitV3.1 \cite[Martin2009].  For
the determination of the weight factor for the cross correlation term we
followed the same protocol but with the optimized force constant for the
centroid based distance restraints using simulated data at 10, 15 and
20Å which were generated as described above.  This gave a value of 50
for the force constant and a weight factor of 15000 for the cross correlation
based energy term, independent of the resolution (results not shown). 

The weight factor for the LCC in the it0-HADDOCK-EM score was determined by
running the benchmark using the optimized parameters and varying the LCC weight
in order to maximize the number of acceptable solutions in the top 400 at the
three resolutions of 10, 15 and 20Å. This gave a value of -400.  The
LCC weight factor in the itw score was determined by maximizing the number of
acceptable solutions in the top 20, which gave a weight factor of -10000.

To investigate the sensitivity of the protocol to incorrectly placed centroids,
we ran 5 cases of the benchmark with displaced centroids.  Each centroid was
moved in a random direction by taking a random point on the unit sphere with a
displacement of 3, 5 and 7Å.  The solutions were analyzed as explained
above.

\Subsection{HADDOCK-EM with symmetry}

To leverage Cn-symmetry in cyclical symmetric complexes a few adjustments were
made to the non-symmetric HADDOCK-EM protocol
(\infigure[fig:symm-protocol]{A}).  The main difference is in the initial
placement of the subunits in the it0-stage.  Instead of placing the subunits on
a sphere, we place them on a circle with its center placed on the middle-point
of the centroids and parallel to the plane of the centroids.  The radius of the
circle is chosen such that the minimal distance between two subunits is at
least 25Å.  The requested Cn- symmetry is imposed on the system from
the start. 

After the initial placement, ambiguous centroid based distance restraints are
generated, i.e. we create a distance restraint between the COM of each subunit
to each centroid.  We form an initial complex again by performing a rigid body
energy minimization, where the energy includes the force field, the
centroid-based distance restraints and the already in HADDOCK available
symmetry restraints.  Once the initial complex is formed, it needs to be
properly oriented in the density.  Only two orientations need to be sampled for
this, namely the current orientation and the upside-down complex.  The
orientation corresponding to the highest cross correlation with the cryo-EM
data is chosen.  A final rigid body energy minimization is performed against
the map, using the cross correlation potential in combination with the force
field and symmetry restraints.  Typically 10000 models are generated.  They are
scored with the it0-HADDOCK-EM and 400 models are refined in the it1 and itw
stage.  The refinement protocol is similar to the non-symmetric HADDOCK-EM
protocol, but with added symmetry restraints.

\Subsection{Modeling protein S7 and S19 of the 30S E. coli ribosome}

For the 30S E. coli ribosome the cryo-EM data were downloaded from the EMDB
(EMD-1884) with its corresponding fitted PDB file (2YKR).  The density
belonging to the interacting ribosomal proteins S7 and S19, was masked out as
follows.  First we subtracted the density of the 16S rRNA modeled at the
specified resolution of 9.8Å from the map.  The density belonging to
the S7 and S19 proteins was masked out by creating a binary mask around the two
proteins with a shell of 7Å.  The centroids were determined by
calculating the COM of each chain as they were fitted in the density in the
2YKR-model.  We followed the standard HADDOCK-EM protocol as described above
using ambiguous centroid distance restraints.  During the docking 10000 models
were generated in it0 and the top 400 best scoring solutions were refined in
it1 and itw.  The solutions were clustered using a cutoff of 7.5Å and
the i-RMSDs were calculated against the 2YKR-model, using ProFit.

\Subsection{Modeling the interaction of KsgA with the 16S rRNA of the 30S E.
coli ribosome}

In order to model the interaction of KsgA with the 16S rRNA of the 30S E. coli
ribosome, we downloaded the 13.5Å cryo-EM map from the EMDB (EMD-2017)
with its corresponding fitted PDB file (4ADV).  Since the 16S rRNA chain can be
unambiguously placed in the cryo-EM map, we used the 16S rRNA as it was fitted
and kept the chain fixed during the it0 stage.  The centroid for KsgA was
determined by performing a full-exhaustive local cross correlation search using
a local version of software similar as described by \citeauthor{Hoang2013},
with an angular sampling interval of 5\Deg. The resulting local cross
correlation map is shown in \insfigure[fig:KsgA-centroids].  The centroid was
placed at the position in the cryo-EM map with the highest local cross
correlation.  We created an initial setup for the rigid body docking by
manually placing KsgA at an approximate distance of 25Å away from the
interaction surface of the 16S rRNA.  During the generation of each solution in
it0, KsgA was given a random orientation and a random translation in a
10Å box.  The initial docking setup with the determined centroid is
shown in \insfigure[fig:KsgA-initial-placement].

Mutagenesis data shows that the residues R221, R222 and K223 of KsgA are vital
in the binding of KsgA to the 16S rRNA, and hydroxyl radical footprinting and
the cryo-EM map show that the helices 24, 27 and 45 of the 16S rRNA are
involved in the binding.  As such, the residues 221 to 223 of KsgA and residues
768 – 773, 781, 782, 801 – 803, 899 – 902, 1512 – 1516 and 1523 of the 16S rRNA
were considered active residues in HADDOCK
(\insfigure[fig:KsgA-initial-placement]{C}).

We generated 10000 models in the rigid body docking stage.  The top 400 scoring
models were only refined in it1.  The water refinement stage was skipped since
full molecular dynamics simulations for 400 models with the ribosome are
computationally too expensive, and the impact of the itw stage is only
marginal.  During the refinement, additional unambiguous distance restraints
were used to keep helix-45 in its place, since it was disconnected from the
main chain but does take part in the interaction.  The i-RMSDs of the refined
models were calculated against the current 4ADV-model.

\Subsection{Modeling the adeno-associated virus-2 complexed with antibody}

For the adeno-associated virus-2 in complex with antibody A20 the 8.5Å
resolution cryo-EM data were obtained from the EMDB (EMD-5424) together with
the fitted PDB (3J1S).  As the resolution allows an unambiguous rigid body fit
of both the capsid protein and the anti-body, the centroids were determined by
calculating the COM of each chain in the 3J1S-model.  Residues within
5Å distance of the other interacting chain were used as active
residues in HADDOCK.  To speed-up the calculation, the density within a
50Å shell was masked out.  I-RMSDs were calculated using 3J1S as a
reference. 

\Subsection{Modeling the interaction between Dengue virus and 2H2 antibody}

Cryo-EM data of 21Å resolution were downloaded from the EMDB
(EMD-5674) and its current model (3J42).  For docking, the antibody was taken
from the current model, while for the envelope-prM complex the original model
was used (3C5X), since the envelope protein-prM complex in 3J42 did not have
any side-chains.  Centroids were determined using a full-cross correlation
search with Laplace pre-filter for both subunits (see
\insfigure[fig:virus-centroids]), similar to the KsgA-ribosome case.  Residues
within 5Å of the other chain in the 3J42 model were used as active
residues during the docking.  The i-RMSDs were calculated using the 3J42 model
as a reference.  

\Subsection{Modeling the large terminase complex}

The 16Å resolution negative stain data were obtained from the EMDB
(EMD-2355) together with its deposited model (4BIJ).  Centroids were determined
by calculating the COM of each subunit in the 4BIJ-model.  The HADDOCK-EM with
symmetry protocol was used, specifically using C5-symmetry restraints.
10000/400/400 models were generated in the it0/it1/itw stage.  The 4BIJ-model
was used as a reference for calculating the i-RMSDs. 

